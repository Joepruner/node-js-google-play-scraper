'use strict';

const requestLib = require('request');
const throttled = require('throttled-request')(requestLib);
const debug = require('debug')('google-play-scraper');

const randUserAgent = require('google-play-scraper/lib/utils/randUserAgent');



function doRequest (opts, limit) {
  let req = requestLib;

  if (limit) {
    throttled.configure({
      requests: limit,
      milliseconds: 1000
    });
    req = throttled;
  }

  return new Promise((resolve, reject) => req(opts, function (error, response, body) {
    if (error) {
      return reject(error);
    }
    if (response.statusCode >= 400) {
      return reject({response});
    }
    resolve(body);
  }));
}

//MODIFIED: Added "User-agent" header calling randUserAgent.js to generate rand user agent for each gplay.app() request.
function request (opts, limit) {
  opts['User-Agent'] = randUserAgent();
  opts['Connection'] = 'keep-alive';
  // console.log(opts['User-Agent']['data']['userAgent']);
  debug('Making request: %j', opts);
  return doRequest(opts, limit)
    .then(function (response) {
      debug('Request finished');
      return response;
    })
    .catch(function (reason) {
      debug('Request error:', reason.message, reason.response && reason.response.statusCode);

      let message = 'Error requesting Google Play:' + reason.message;
      if (reason.response && reason.response.statusCode === 404) {
        message = 'App not found (404)';
      }
      const err = Error(message);
      err.status = reason.response && reason.response.statusCode;
      throw err;
    });
}

module.exports = request;
